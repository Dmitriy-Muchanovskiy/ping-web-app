# Техническое задание

## Веб-сервис на Java, при get-запросе по пути /ping отдаёт pong+дата+время+версия_java_проекта
## Шаги сборки, развёртывания и обновление/откат

1. Сборка Docker image
1. Развёртывание в minikube полученного image
1. Обновление и откат на предыдующую версию

## Сборка Docker image
> В данной инструкции допускается, что docker_image собирается локально и запускается в minikube так же с локального docker_repository.

Сборка docker_image первой версии \
``docker build --rm -t ping_task:1.0.0 .``

Для шагов обновления и развёртывания требуется вторая версия docker_image. Для этого необходимо что-либо обновить, для упрощения, предалагаю изменить в ``pom.xml`` версию проекта на ``1.0.1`` \
``sed -i 's/1.0.0/1.0.1/g' pom.xml`` \
Теперь соберём docker_image новой версии \
``docker build --rm -t ping_task:1.0.1 .``

## Развёртывание в minikube полученного image
> Запуск minikube опускаю, предполагая его запущенным

Запуск Deployment для версии 1.0.0 \
``kubectl apply -f k8s/deploy-1.yml``

Запуск Service для полученного Deployment'a  \
``kubectl apply -f k8s/service.yml``

Ссылка на Service \
``minikube service service-example-onefactor --url``

Проверить доступность сервиса можно через браузер с путём ``полученная_ссылка/ping`` или через curl \
``Например, curl http://192.168.99.107:32208/ping`` \
Ответ должен быть подобный этому тексту ``pong 2022-03-08 18:26:03 1.0.0``

## Обновление и откат на предыдующую версию

Обновляем Deployment до версии 1.0.1 \
``kubectl apply -f k8s/deploy-2.yml``

Проверяем, что обновление будет выполнено без простоя сервиса
```bash
service=$(minikube service service-example-onefactor --url)
while sleep 0.5; do curl "$service/ping"; echo ""; done
```
Когда развёртывание новой версии закончится, то ответ начнёт поступать подобно следующему тексту ``pong 2022-03-08 18:26:03 1.0.1``, значит всё ок и можно оставливать цикл.

Для отката развёрнутого в k8s приложения на предыдущую версию, необходимо выполнить следующую команду \
``kubectl rollout undo deploy deploy-example-onefactor``\
Проверить корректность отката можно аналогично предыдущему шагу.

### P.S.
Данный вариант развёртывания не очень эффективен, т.к. старая версия сразу же заменяет на новую. Правильнее делать Deployment и Serive с новой версией, проверять, что всё корректно, а потом через Ingress менять старую версию на новую. Когда новый сервис успешно поехал, удаляются старые версии Deployment и Service.
Это требует больших ресурсов, но позволяет получить более надёжный сервис, т.к. позволяет проврить новую версию, а потом только дать доступ клиентам.

Через minikube такой вариант показать не получиться, т.к. в нём не корректно работает Ingress.
